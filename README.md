symfony.local
=============

Тестовое задание для компании DDI.
Срок - 2 недели.
При этом Angular, Symfony, Bootstrap - для меня были новыми технологиями, и у меня была работа на полный рабочий день (8 часов в день).

Ценность задачи - в очень сжатые сроки изучить новые технологии и применить их.

Посмотреть в живую можно тут: http://symfony.llk-guild.ru/

Текст задания:
=============
Stack:
  - Symfomy 2
  - Angular 1
  - Bootstrap
  - обещение через REST API
  - MySQL

Task:
  - авторизация, мыло и две любые социалки
  - профиль, с возможностью привязать все социалки (две).
    Т.е. возможность логина в один профиль через 3 провайдера (2 социалки и мыло)
    Добавление аватара. Создание тумбы для аватара.
  - 2 роли пользователей, модератор и обычный.
  - добавление постов. Простых, текст с картинками, можно html или какой-нибудь markdown. TinyMCE или любой другой wysiwyg редактор.
  - Возможность их расшарить по мылу. Или в системе пользователь или новый, который после регистрации получает доступ.
    Возможность расшарить по  линку. Подсчет просмотров.
  - У модератор видит всё и может менять всё. Админка модератора: пользователи, посты.
    Пользователи только свои и расшаренные на них.

Моя рецензия на эту работу, перед сдачей задания:
=============
Поскольку задание "абстракция" - то я решил сделать "сайт на котором пользователи могут писать сообщения восхваляя symfony".

Должен отметить, что задание получилось объёмное и было мне очень не просто его выполнить - в виду того, что у меня есть работа на которую надо тратить по 8 часов рабочего времени в день (как бы странно это ни звучало). И symfony, angular и bootstrap я использовал впервые.


Также хотелось бы рассказать как я реализовал те вещи, которые могли бы быть сделаны по разному (и в реальной жизни я бы уточнял как лучше сделать, но тут уточнения были бы неуместны, имхо).

1. Авторизация через социальные сети я выбрал vk и google. vk потому что позволяет выполнять oauth локально, а google мне просто нравится (хотя у меня есть готовый код ещё для facebook, ok, yahoo, yandex и подключение к этому сайту займёт около 10 минут). Oauth ключи не выносил в конфиг.
2. Авторизация через vk я сделал без обязательного email. Админы vk во время обсуждения одного технического вопроса убедили меня, что надо стараться не требовать от пользователя email. Во первых это может отпугнуть пользователя, а во вторых у некоторых его может просто не быть (авторизация только через телефон например). Поэтому я принял решение делать возможность регистрации через соц сети без email (хотя стоит заметить - это значительно сложнее в реализации, чем реализация с обязательным email).
3. То, что у учётных записей нет явного идентификатора (который было бы легко использовать в виде email) - могут возникнуть ситуации, когда авторизация двух аккаунтов пересекается. Например, пользователь зарегистрировался с использованием email, отлогинелся, зарегистрировался с использованием соц сети, зашёл в профиль и пытается установить тот email, уже подтверждённый в другом аккаунте. Я решил в таких ситуациях выполнять слияние аккаунтов. Сайт маленький и это делается очевидным образом.
4. При регистрации через соц сети я сделал отдельную страницу "вы уверены что хотите зарегистрироваться?". Это сделано специально, хотя может показаться странным.
5. В профиле можно получить или отдать роль модератора (в реальной жизни такого не бывает, но я ставил задачу, чтобы можно было получить роль модератора без моего участия).
6. Аватар можно установить двумя способами - первый это через профиль, тыкнуть в соответствующее место, указать файлик и обновить аватар. В этом случае на сервере будет сохранён оригинальный файл и вырезанный квадрат уменьшенный до 100*100 (та "тумба" о которой я спрашивал). Второй способ - это использование аватарок из соц сетей (для этого надо зайти через соц сеть без аватара в профиле). Так вот по хорошему надо сохранять себе эти аватарки на сервер, но я решил этого не делать.
7. Главная страница сайта - это список сообщений для залогиненного пользователя или форма логина/реагистрации для гостя.
8. Список сообщений выполнен без постранички. В реальной жизни такое встречаться не должно в подобных местах, но у нас же абстрактный сайт и про это ничего не сказано было. Решил не делать.
9. Добавление/редактирование сообщений с использованием редактора CKEditor. Хотел сделать, чтобы можно было "закидывать" картинки в редактор (со всеми сложностями от этого) - но за приемлемое время не удалось настроить конфиг CKEditor и я оставил только возможность указывать ссылки на картинки (хотя я не раз делал этот CKEditor с закидыванием картинок и с использованием filemanager).
10. Всё не очевидное поведение я старался снабдить комментариями и пояснениями в коде, а также использовать PHPDOC, чтобы был известен тип каждой переменной везде.
11. В коде можно встретить очень много TODO. Потому что сроки-то очень сжатые. И была поставлена цель сделать сначала все фичи, потом поправить баги, потом уже допиливать напильником. Кстати очень хорошая практика для реальных приложений - сделать быстро и расставить море TODO. Если не надо допиливать - то и хорошо, время сэкономлено. Если надо допиливать - вот собственно все TODO отмечены, бери и делай.
12. В админке в управлении пользователями я запретил удаление пользователя. И запретил изменение email. Хотя в задании сказано "модератор видит всё и может менять всё". Так вот это "всё" понятие растяжимое. Я уверен, что в реальной жизни, например хэши паролей видеть, а тем более менять - не надо.
13. Возможность шарить по линку - я решил сделать с возможностью посещения гостями.
14. Подсчёт просмотров можно сделать очень по разному. Я решил считать уникальных пользователей, которые просмотрели конкретное сообщение. Гость - как пользователь с id = 0. Почему я решил сделать так - если я не ошибаюсь, то на Хабре примерно такая реализация.
15. Отдельно стоит отметить главную страницу для гостя. Сразу скажу - защиты от брутфорса нет, но её легко сделать навесив sleep(5) в нужных местах. Весь процесс авторизации выполняется на одной странице (angular жи проверял на что способен). Авторизация может пойти путём логина или регистрации или восстановление пароля или подтверждение регистрации. Также могут быть ситуации, когда пароль не задан - они тоже корректно обрабатываются. Обычно при регистрации отправляется письмо со ссылкой завершения регистрации. Я посчитал такое неуместным тут, хотя в реальной жизни в 90% случаев такое лучше реализовывать. Реализовал только письма с кодом.
16. Подтверждение пароля при указании нового пароля нигде не требуется - это так и задумано. Потому что все "ошибающиеся" пользователи давно использую вход через соц сети, а кто сейчас использует вход через email - тот и не ошибается при вводе нового пароля. Не нужно напрягать пользователя лишним действием.
17. По возможности на странице авторизации я старался исключить лишние кнопки, насколько это возможно. Поэтому приложение оживает как только введено что-то ценное и пользователь обычно жмёт кнопку. Непривычно кому-то, да. Но это прогресс я считаю.
18. Ещё хорошая практика - перед любым удалением делать окошечко "а вы уверены?". Но руки не дошли до этого.


Ещё хотелось бы написать, про технические моменты:
1. bootstrap - божественен, я не поймал ни одну проблему с ним за всё время разработки и использовать его было легко, удобно и приятно.
2. Angular - это по сути надстройка над jquery. И просмотр обучения http://campus.codeschool.com/courses/shaping-up-with-angular-js/intro меня привёл в ярость. Потому что очень жаль, что я так поздно про этот инструмент узнал. Речь идёт о сотнях часов, которые могли бы быть сэкономлены, а фичи сделаны были бы быстрее и качественнее. Из проблем - столкнулся с морганием (когда angular ещё не загрузился, а элементы ng-hide ещё отображаются), как сделать это в нормальном виде - так и не нашёл. Затычку можно увидеть в начале /app.js .
3. Symfony - запомнился он мне тем "это тот фрэймвёрк, который кэширует имя БД из конфига". Роутинг у него сделан замечательно. Но у меня ещё много вопросов типа "куда писать этот код?". Поэтому очень много дублирующего кода (например проверка авторизации). Doctrine не умеет работать с timestamp чем меня очень сильно расстроило. twig очень понравился.
4. Git - я сначала хотел поднять свой git server, но за приемлемое время не удалось это сделать. Остановился на авторизации, но гостевой доступ на запись - это вообще неок. Потом завёл учётную запись на github (да, только сейчас, уже осознаю упущенные возможности).
5. Composer - ещё было проблемой понять чего надо комитать, а чего не надо. С пятой попытки разобрался. Я долго не мог поверить, что этот composer работает так, как он работает. Но когда я наконец понял - я осознал масштаб бедствия, насколько сильно я отстал от жизни.
6. rest api - я старался сделать по следующему принципу "get/post/put/delete" соответствуют "получение/создание/изменение/удаление". Хотя местами это не очевидно - вот удаление аватара. Это удаление каринки или изменение профиля?
7. Mysql - у меня богатый опыт, поэтому в этом задании ничего нового не было, пароли я сохраняю в md5 виде, без соли (хотя по-моему уже нельзя делать хранилище паролей без соли). Ну и пришлось отказаться от использования timestamp. DB schema положил в "/app/Resources/schema.sql", насколько я понял правильнее сделать Doctrine Schema, но в вижу очень сжатых сроков - нет времени сделать так.
8. url history - при всех действиях в рамках одной страницы (без смены url) - выводятся уведомления типа "всё хорошо" или "ошибка такая-то" или ещё что-то. А если действие выходит за рамки страницы, например удаление сообщения - то сообщение не выводится.